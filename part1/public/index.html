<!DOCTYPE html>
<html lang="en">
<head>
  <title>My App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./stylesheets/style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
  <div id="app">
    <div v-if="notification.visible" :class="['notification', notification.type]">
      {{ notification.message }}
    </div>

    <h1>Dog Walking Service</h1>
    <!-- <p>This is a simple Vue.js application.</p> -->
    <div v-for="request in walkrequests">
        <h2>Dog name: {{ request.dog_name }}</h2>
        <p>Request ID: {{request.request_id}} </p>
        <img :src="request.dogImg" alt="">
        <p>Time:{{ request.requested_time}}</p>
        <p>Duration: {{ request.duration_minutes }} minutes</p>
        <p>Location: {{ request.location }}</p>
        <p>Owner: {{ request.owner_username }}</p>
    </div>

    <form action="">
      <h2>Apply for a walk request</h2>
      <input type="text" v-model="request.request_id" placeholder="Request ID">
      <input type="text" v-model="request.dog_name" placeholder="Dog Name">
      <button type="submit" >Apply</button
    </form>
  </div>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          notification: {
            visible: false,
            message: '',
            type: '' // 'success' or 'error'
          },
          dogImg: '',
          walkrequests: [],
          request: {
            request_id: '',
            dog_name: '',
          },
        }
      },
      methods: {
        async getDogImg() {
          try {
            console.log('Fetching dog image...');
            const response = await fetch('https://dog.ceo/api/breeds/image/random');
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Network response was not ok');
            }
            // deal with the result
            this.dogImg = result.message;
            console.log(this.dogImg);
            this.showNotification('Data fetched successfully!', 'success');
            return result.message;
          } catch (error) {
            console.error('Error fetching dog image:', error);
            this.showNotification('Failed to fetch data.', 'error');
          }
        },
        async fetchRandomDogImg() {
          try {
            const response = await fetch('https://dog.ceo/api/breeds/image/random');
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Network response was not ok');
            }
            return result.message; // return image URL
          } catch (error) {
            console.error('Error fetching dog image:', error);
            return ''; // fallback empty image
          }
        },
        async getWalkrequests() {
          try {
            console.log('Fetching dog to walk...');
            const response = await fetch('/api/walkrequests/open');
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.error || 'Network response was not ok');
            }
            // deal with the result
            const requestsWithImages = await Promise.all(result.map(async (request) => {
              const img = await this.fetchRandomDogImg();
              return { ...request, dogImg: img };
            }));
            this.walkrequests = requestsWithImages;
            console.log(this.walkrequests);
            this.showNotification('Data fetched successfully!', 'success');
          } catch (error) {
            console.error('Error fetching dog image:', error);
            this.showNotification('Failed to fetch data.', 'error');
          }
        },
        showNotification(msg, type) {
          this.notification.message = msg;
          this.notification.type = type;
          this.notification.visible = true;
          setTimeout(() => {
            this.notification.visible = false;
          }, 5000);
        },
      },
      mounted() {
        this.getWalkrequests();
      }
    });
    app.mount('#app');
  </script>
</body>
</html>